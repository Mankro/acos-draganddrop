(function(){var e,t,s={}.hasOwnProperty;t=function(){class e{constructor(e,t){this.element=$(e),this.settings=$.extend({},this.constructor.defaults,t),this.draggablesPayload=window.draganddrop.draggables,this.droppablesPayload=window.draganddrop.droppables,this.latestAnswers={},this.droppablesByLabel={},this.origDropContents={},this.contentDiv=this.element.find(this.settings.content_selector),this.feedbackDiv=this.element.find(this.settings.feedback_selector),this.infoDiv=this.element.find(this.settings.info_selector)}getFeedback(e,t,s){var a,r,n;return n=void 0,r=this.droppablesPayload[t],a=this.draggablesPayload[e],n=r.feedback&&r.feedback[e]?r.feedback[e]:a.feedback&&a.feedback[t]?a.feedback[t]:r.feedback&&r.feedback.DEFAULT?r.feedback.DEFAULT:a.feedback&&a.feedback.DEFAULT?a.feedback.DEFAULT:"[ERROR: no feedback set]",n+=this.getComboFeedback(e,t,s,!0)}getComboFeedback(e,t,s,a){var r,n,i,o,l,d,c,g,h,p,m,f,b,u,v,w,_,D,C,A;if(!window.draganddrop.combinedfeedback)return!1===a?[]:"";for(l=[],window.draganddrop.combinedfeedback.length,c=0,p=(_=window.draganddrop.combinedfeedback).length;c<p;c++)if((n=_[c]).combo&&n.feedback){for(r=!0,i=!1,A=!0===n.useDroppableId,g=0,m=(D=n.combo).length;g<m;g++){if(v=D[g],!i&&v[0]===e&&(!A&&v[1]===t.toString()||A&&v[1]===s)&&(i=!0),w=!1,A)this.latestAnswers[v[1]]===v[0]&&(w=!0);else for(h=0,f=(C=this.droppablesByLabel[v[1]]).length;h<f;h++)if(o=C[h],this.latestAnswers[o]===v[0]){w=!0;break}if(!w){r=!1;break}}n.combo.length>0&&r&&i&&l.push(n.feedback)}if(!1===a)return l;for(d="",u=0,b=l.length;u<b;u++)d+='<br><span class="draganddrop-combinedfeedback">'+l[u]+"</span>";return d}isCorrectAnswer(e,t){var s,a;return s=this.droppablesPayload[t],a=!1,Array.isArray(s.correct)?-1!==s.correct.indexOf(e)&&(a=!0):s.correct===e&&(a=!0),a}updateFeedback(e,t){this.feedbackDiv.html(e).removeClass("correct wrong"),t?this.feedbackDiv.addClass("correct"):this.feedbackDiv.addClass("wrong")}revealAnswerInDroppable(e,t,s){var a,r,n,i,o,l,d,c,g,h,p,m,f;o=t.data("id"),i=this.draggablesPayload[e],n=!1,null==(l=this.droppablesPayload[t.data("label")]).revealCorrect&&s||null==l.revealWrong&&!s?(!1===i.reveal||!1===i.revealCorrect&&s||!1===i.revealWrong&&!s)&&(n=!0):(!1===l.revealCorrect&&s||!1===l.revealWrong&&!s)&&(n=!0),n?t.html(this.origDropContents[o]):(d=function(e,t){var s,a,r,n;for(s=a=0,n=(r=["replace","append","prepend"]).length;0<=n?a<n:a>n;s=0<=n?++a:--a)e.hasOwnProperty(r[s])&&(t[s]=e[r[s]])},m=[h=!1,a=!1,c=!1],f=!1,l.revealCorrect&&s?d(l.revealCorrect,m):l.revealWrong&&!s?d(l.revealWrong,m):i.reveal?d(i.reveal,m):i.revealCorrect&&s?d(i.revealCorrect,m):i.revealWrong&&!s?d(i.revealWrong,m):f=!0,f?h=i.content:(h=m[0],a=m[1],c=m[2]),g="",p="",r="",p=h?"<span>"+h+"</span>":this.origDropContents[o],a&&(r='<span class="small drop-reveal"> ['+a+"]</span>"),c&&(g='<span class="small drop-reveal">['+c+"] </span>"),t.html(g+p+r))}setInfoPosition(){var e;.8*$(window).height()>this.contentDiv.height()?(this.infoDiv.removeClass("fixed"),this.contentDiv.removeClass("fixed-info"),this.infoDiv.css("maxHeight",""),this.contentDiv.css("marginBottom","")):(this.infoDiv.addClass("fixed"),this.contentDiv.addClass("fixed-info"),e=.25*$(window).height(),this.infoDiv.css("maxHeight",e),this.contentDiv.css("marginBottom",e))}}return e.defaults={feedback_selector:".draganddrop-feedback",droppable_selector:".droppable",content_selector:".draganddrop-content",info_selector:".draganddrop-info"},e}.call(this),e=function(){class e extends t{constructor(e,t){super(e,t),this.completed=!1,this.questionAnswered={},this.pointsDiv=this.element.find(this.settings.points_selector),this.completeDiv=this.element.find(this.settings.completed_selector),this.completeMsg=this.element.find(this.settings.completed_msg_selector),this.finalComment=this.element.find(this.settings.final_comment_selector),this.correctPointsElem=this.element.find(this.settings.correct_answers_selector),this.wrongPointsElem=this.element.find(this.settings.wrong_answers_selector),this.dragsLeftMsgDiv=this.element.find(this.settings.drags_left_msg_selector),this.draggablesContainer=this.element.find(this.settings.draggables_selector),this.quitButton=this.element.find(this.settings.quit_button_selector),this.correctAnswers=0,this.incorrectAnswers=0,this.maxCorrectAnswers=this.element.find(this.settings.droppable_selector).length,this.answerLog=[],this.dragData=null,this.init()}init(){var e,t,a,r,n,i,o,l;for(a in o=this,i=this.draggablesPayload)s.call(i,a)&&(l=(n=i[a]).content,e=n.htmlclass,(t=$("<span>")).addClass(o.settings.draggable_class).attr("data-label",a).attr("draggable","true").html(l).appendTo(this.draggablesContainer),e&&t.addClass(e));return r=0,this.element.find(this.settings.droppable_selector).each(function(){var e,t;t=r++,$(this).data("id",t),e=$(this).data("label"),Array.isArray(o.droppablesByLabel[e])?o.droppablesByLabel[e].push(t):o.droppablesByLabel[e]=[t],o.questionAnswered[t]=[],o.latestAnswers[t]=null,o.origDropContents[t]=$(this).html()}).on("dragover",function(e){return o.handleDragOver(e,$(this))}).on("dragenter",function(e){return o.handleDragEnter(e,$(this))}).on("dragleave",function(e){return o.handleDragLeave(e,$(this))}).on("drop",function(e){return o.handleDrop(e,$(this))}).on("click",function(e){return o.handleDroppableClick(e,$(this))}),this.draggablesContainer.find(this.settings.draggable_selector).on("dragstart",function(e){return o.handleDragStart(e,$(this))}).on("dragend",function(e){return o.handleDragEnd(e,$(this))}),this.quitButton.click(function(){o.completeExercise(!0)}),this.setInfoPosition(),this.setDraggablesPosition(),$(window).on("resize",function(){return o.setInfoPosition(),o.setDraggablesPosition()})}handleDragStart(e,t){var s,a,r;if(e.originalEvent.dataTransfer.effectAllowed="copy",e.originalEvent.dataTransfer.dropEffect="copy",(a=t.find("img")).length){r=a.get(0);try{e.originalEvent.dataTransfer.setDragImage(r,r.width/2,0)}catch(e){e}}t.css("opacity","0.5"),s=t.data("label");try{e.originalEvent.dataTransfer.setData("text/plain",s)}catch(t){t,e.originalEvent.dataTransfer.setData("text",s)}this.dragData=s}handleDragOver(e,t){var s;s=null;try{s=e.originalEvent.dataTransfer.getData("text/plain")}catch(t){t,s=e.originalEvent.dataTransfer.getData("text")}return s||(s=this.dragData),!(s&&this.draggablesPayload[s]&&!t.hasClass("correct"))||(e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="copy",!1)}handleDragEnter(e,t){e.preventDefault(),t.hasClass("correct")||t.addClass("over")}handleDragLeave(e,t){t.removeClass("over")}handleDrop(e,t){var s,a;e.stopPropagation(),e.preventDefault(),s=null;try{s=e.originalEvent.dataTransfer.getData("text/plain")}catch(t){t,s=e.originalEvent.dataTransfer.getData("text")}return s||(s=this.dragData),a=t.data("label"),this.checkAnswer(s,a,t),!1}handleDragEnd(e,t){t.css("opacity",""),this.element.find(this.settings.droppable_selector).removeClass("over"),this.dragData=null,this.completed&&this.detachDragEventHandlers()}handleDroppableClick(e,t){var s,a,r,n,i;return e.stopPropagation(),e.preventDefault(),a=t.data("id"),!(this.questionAnswered[a].length<1)&&(s=this.latestAnswers[a],r=t.data("label"),n=this.getFeedback(s,r,a),this.updateFeedback(n,this.isCorrectAnswer(s,r)),this.completed||(i={qid:a,qlabel:r,alabel:s,time:(new Date).toISOString(),click:!0},this.answerLog.push(i)),!1)}checkAnswer(e,t,s){var a,r,n,i,o,l;this.completed||s.hasClass("correct")||(r=s.data("id"),this.latestAnswers[r]=e,l=!0,-1===this.questionAnswered[r].indexOf(e)&&(this.questionAnswered[r].push(e),l=!1),a=this.draggablesPayload[e],i=this.isCorrectAnswer(e,t),n=this.getFeedback(e,t,r),this.updateFeedback(n,i),s.removeClass("correct wrong"),i?(s.addClass("correct"),a.htmlclass&&s.addClass(a.htmlclass),l||this.correctAnswers++,!1===a.reuse&&this.disableDraggable(e)):(s.addClass("wrong"),l||this.incorrectAnswers++),this.revealAnswerInDroppable(e,s,i),this.updatePoints(),this.updateCorrectDragsLeftMessage(),o={qid:r,qlabel:t,alabel:e,time:(new Date).toISOString()},l&&(o.rerun=!0),this.answerLog.push(o),this.quitButton.prop("disabled",!1),this.checkCompletion())}checkCompletion(){this.correctAnswers>=this.maxCorrectAnswers&&this.completeExercise(!1)}completeExercise(e=!1){if(!this.completed)return this.completed=!0,this.quitButton.prop("disabled",!0),e||this.dragsLeftMsgDiv.hide(),e&&this.detachDragEventHandlers(),this.completeMsg.text(this.completeDiv.attr(this.settings.complete_msg_attr)),this.completeDiv.removeClass("hide").show(),this.grade(),this.sendLog()}grade(){var e,t,s,a;a=this,"/html/"!==window.location.pathname.substring(0,6)&&this.completeMsg.text(this.completeDiv.attr(this.settings.complete_uploading_msg_attr)),t=3*(this.maxCorrectAnswers-this.correctAnswers),s=Math.round(this.maxCorrectAnswers/(this.correctAnswers+this.incorrectAnswers+t)*100),this.addFinalPointsString(this.pointsDiv,s),this.showFinalComment(s),e=this.buildFinalFeedback(),window.ACOS&&window.ACOS.sendEvent("grade",{max_points:100,points:s,feedback:e},function(e,t){t?a.completeMsg.text(a.completeDiv.attr(a.settings.complete_error_msg_attr)+t.error):"/html/"!==window.location.pathname.substring(0,6)&&a.completeMsg.text(a.completeDiv.attr(a.settings.complete_uploaded_msg_attr))})}sendLog(){window.ACOS&&window.ACOS.sendEvent("log",this.answerLog)}disableDraggable(e){var t;(t=this.draggablesContainer.find(this.settings.draggable_selector+'[data-label="'+e+'"]')).attr("draggable","false").addClass("disabled"),t.find("img, a").attr("draggable","false")}updatePoints(){this.correctPointsElem.text(this.correctAnswers),this.wrongPointsElem.text(this.incorrectAnswers),this.pointsDiv.removeClass("hide").show()}updateCorrectDragsLeftMessage(){var e,t,s;this.correctAnswers>=.5*this.maxCorrectAnswers&&(s=1===(e=this.maxCorrectAnswers-this.correctAnswers)?this.settings.drags_left_singular_msg_attr:this.settings.drags_left_plural_msg_attr,t=(t=this.dragsLeftMsgDiv.attr(s)).replace("{counter}",e.toString()),this.dragsLeftMsgDiv.html(t),this.dragsLeftMsgDiv.removeClass("hide").show())}showFinalComment(e){var t,a,r,n,i,o;if(o=window.draganddrop.finalcomment){for(r in a="",o.common&&(a+=o.common+"<br>"),i=[],o)s.call(o,r)&&(o[r],n=parseInt(r,10),isNaN(n)||i.push([n,r]));i.sort(function(e,t){return e[0]<t[0]?-1:e[0]>t[0]?1:0}),-1!==(t=i.findIndex(function(t){return e<=t[0]}))&&(a+=o[i[t][1]]),this.finalComment.html(a),this.finalComment.removeClass("hide").show()}}detachDragEventHandlers(){this.element.find(this.settings.droppable_selector).off("dragover dragenter dragleave drag"),this.draggablesContainer.find(this.settings.draggable_selector).off("dragstart dragend").attr("draggable","false").addClass("finished")}addFinalPointsString(e,t){var s;s=(s=e.attr(this.settings.final_points_msg_attr)).replace("{score}",t.toString()),e.prepend(s)}setDraggablesPosition(){var e;.8*$(window).height()>this.contentDiv.height()?(this.draggablesContainer.removeClass("fixed"),this.contentDiv.removeClass("fixed-draggables"),this.draggablesContainer.css("maxHeight",.25*$(window).height()),this.contentDiv.css("marginTop","")):(this.draggablesContainer.addClass("fixed"),this.contentDiv.addClass("fixed-draggables"),this.draggablesContainer.css("maxHeight",""),e=Math.min(this.draggablesContainer.height(),.25*$(window).height()),this.draggablesContainer.css("maxHeight",e),this.contentDiv.css("marginTop",e))}buildFinalFeedback(){return{answers:this.questionAnswered,correctAnswers:this.correctAnswers,incorrectAnswers:this.incorrectAnswers}}}return e.pluginName="acosDragAndDrop",e.defaults=$.extend({},t.defaults,{points_selector:".draganddrop-points",correct_answers_selector:".draganddrop-correct-answers",wrong_answers_selector:".draganddrop-wrong-answers",completed_selector:".draganddrop-complete",draggable_selector:".draggable",draggable_class:"draggable",draggables_selector:".draganddrop-draggables",complete_msg_attr:"data-msg-complete",complete_uploading_msg_attr:"data-msg-complete-uploading",complete_uploaded_msg_attr:"data-msg-complete-uploaded",complete_error_msg_attr:"data-msg-complete-error",completed_msg_selector:".draganddrop-complete-msg",final_comment_selector:".draganddrop-finalcomment",final_points_msg_attr:"data-msg-final",drags_left_msg_selector:".draganddrop-dragsleftmsg",drags_left_singular_msg_attr:"data-msg-singular",drags_left_plural_msg_attr:"data-msg-plural",quit_button_selector:"[data-quit-button]"}),e}.call(this),$.fn[e.pluginName]=function(t){return this.each(function(){$.data(this,"plugin_"+e.pluginName)||$.data(this,"plugin_"+e.pluginName,new e(this,t))})},$(function(){return $(".draganddrop").acosDragAndDrop()})}).call(this);