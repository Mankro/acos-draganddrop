(function(){var e,t,s={}.hasOwnProperty;t=function(){class e{constructor(e,t){this.element=$(e),this.settings=$.extend({},this.constructor.defaults,t),this.draggablesPayload=window.draganddrop.draggables,this.droppablesPayload=window.draganddrop.droppables,this.latestAnswers={},this.droppablesByLabel={},this.origDropContents={},this.contentDiv=this.element.find(this.settings.content_selector),this.feedbackDiv=this.element.find(this.settings.feedback_selector),this.infoDiv=this.element.find(this.settings.info_selector)}getFeedback(e,t,s){var a,r,i;return i=void 0,r=this.droppablesPayload[t],a=this.draggablesPayload[e],i=r.feedback&&r.feedback[e]?r.feedback[e]:a.feedback&&a.feedback[t]?a.feedback[t]:r.feedback&&r.feedback.DEFAULT?r.feedback.DEFAULT:a.feedback&&a.feedback.DEFAULT?a.feedback.DEFAULT:"[ERROR: no feedback set]",i+=this.getComboFeedback(e,t,s,!0)}getComboFeedback(e,t,s,a){var r,i,n,o,l,d,g,c,h,p,m,f,b,u,v,D,w,_,C,A;if(!window.draganddrop.combinedfeedback)return!1===a?[]:"";for(l=[],window.draganddrop.combinedfeedback.length,g=0,p=(w=window.draganddrop.combinedfeedback).length;g<p;g++)if((i=w[g]).combo&&i.feedback){for(r=!0,n=!1,A=!0===i.useDroppableId,c=0,m=(_=i.combo).length;c<m;c++){if(v=_[c],!n&&v[0]===e&&(!A&&v[1]===t||A&&v[1]===s)&&(n=!0),D=!1,A)this.latestAnswers[v[1]]===v[0]&&(D=!0);else for(h=0,f=(C=this.droppablesByLabel[v[1]]).length;h<f;h++)if(o=C[h],this.latestAnswers[o]===v[0]){D=!0;break}if(!D){r=!1;break}}i.combo.length>0&&r&&n&&l.push(i.feedback)}if(!1===a)return l;for(d="",u=0,b=l.length;u<b;u++)d+='<br><span class="draganddrop-combinedfeedback">'+l[u]+"</span>";return d}isCorrectAnswer(e,t){var s,a;return s=this.droppablesPayload[t],a=!1,Array.isArray(s.correct)?-1!==s.correct.indexOf(e)&&(a=!0):s.correct===e&&(a=!0),a}updateFeedback(e,t){this.feedbackDiv.html(e).removeClass("correct wrong"),t?this.feedbackDiv.addClass("correct"):this.feedbackDiv.addClass("wrong")}revealAnswerInDroppable(e,t,s){var a,r,i,n,o,l,d,g,c,h,p,m,f;o=t.data("id"),n=this.draggablesPayload[e],i=!1,null==(l=this.droppablesPayload[t.data("label").toString()]).revealCorrect&&s||null==l.revealWrong&&!s?(!1===n.reveal||!1===n.revealCorrect&&s||!1===n.revealWrong&&!s)&&(i=!0):(!1===l.revealCorrect&&s||!1===l.revealWrong&&!s)&&(i=!0),i?t.html(this.origDropContents[o]):(d=function(e,t){var s,a,r,i;for(s=a=0,i=(r=["replace","append","prepend"]).length;0<=i?a<i:a>i;s=0<=i?++a:--a)e.hasOwnProperty(r[s])&&(t[s]=e[r[s]])},m=[h=!1,a=!1,g=!1],f=!1,l.revealCorrect&&s?d(l.revealCorrect,m):l.revealWrong&&!s?d(l.revealWrong,m):n.reveal?d(n.reveal,m):n.revealCorrect&&s?d(n.revealCorrect,m):n.revealWrong&&!s?d(n.revealWrong,m):f=!0,f?h=n.content:(h=m[0],a=m[1],g=m[2]),c="",p="",r="",p=h?"<span>"+h+"</span>":this.origDropContents[o],a&&(r='<span class="small drop-reveal"> ['+a+"]</span>"),g&&(c='<span class="small drop-reveal">['+g+"] </span>"),t.html(c+p+r))}setInfoPosition(){var e;.8*$(window).height()>this.contentDiv.height()?(this.infoDiv.removeClass("fixed"),this.contentDiv.removeClass("fixed-info"),this.infoDiv.css("maxHeight",""),this.contentDiv.css("marginBottom","")):(this.infoDiv.addClass("fixed"),this.contentDiv.addClass("fixed-info"),e=.25*$(window).height(),this.infoDiv.css("maxHeight",e),this.contentDiv.css("marginBottom",e))}}return e.defaults={feedback_selector:".draganddrop-feedback",droppable_selector:".droppable",content_selector:".draganddrop-content",info_selector:".draganddrop-info"},e}.call(this),e=function(){class e extends t{constructor(e,t){super(e,t),this.completed=!1,this.questionAnswered={},this.pointsDiv=this.element.find(this.settings.points_selector),this.completeDiv=this.element.find(this.settings.completed_selector),this.completeMsg=this.element.find(this.settings.completed_msg_selector),this.finalComment=this.element.find(this.settings.final_comment_selector),this.correctPointsElem=this.element.find(this.settings.correct_answers_selector),this.wrongPointsElem=this.element.find(this.settings.wrong_answers_selector),this.dragsLeftMsgDiv=this.element.find(this.settings.drags_left_msg_selector),this.draggablesContainer=null,this.quitButton=this.element.find(this.settings.quit_button_selector),this.correctAnswers=0,this.incorrectAnswers=0,this.maxCorrectAnswers=this.element.find(this.settings.droppable_selector).length,this.answerLog=[],this.dragData=null,this.selectedDrag=null,this.init()}init(){var e,t;return t=this,this.initDraggables(),e=0,this.element.find(this.settings.droppable_selector).each(function(){var s,a;a=e++,$(this).data("id",a),s=$(this).data("label").toString(),Array.isArray(t.droppablesByLabel[s])?t.droppablesByLabel[s].push(a):t.droppablesByLabel[s]=[a],t.questionAnswered[a]=[],t.latestAnswers[a]=null,t.origDropContents[a]=$(this).html()}).on("dragover",function(e){return t.handleDragOver(e,$(this))}).on("dragenter",function(e){return t.handleDragEnter(e,$(this))}).on("dragleave",function(e){return t.handleDragLeave(e,$(this))}).on("drop",function(e){return t.handleDrop(e,$(this))}).on("click",function(e){return t.handleDroppableClick(e,$(this))}),this.draggablesContainer.find(this.settings.draggable_selector).on("dragstart",function(e){return t.handleDragStart(e,$(this))}).on("dragend",function(e){return t.handleDragEnd(e,$(this))}).on("click",function(e){return t.handleDraggableClick(e,$(this))}),this.quitButton.click(function(){t.completeExercise(!0)}),this.setInfoPosition(),this.setDraggablesPosition(),$(window).on("resize",function(){return t.setInfoPosition(),t.setDraggablesPosition()})}initDraggables(){var e,t,a,r,i,n,o;for(a in this.draggablesContainer=this.contentDiv.find(this.settings.draggables_selector).empty(),this.draggablesContainer.length?this.draggablesContainer.hasClass("vertical")&&this.element.addClass(this.draggablesContainer.hasClass("right")?"vertical-right-draggables":"vertical-draggables"):this.draggablesContainer=$("<div></div>").addClass(this.settings.draggables_container_class).prependTo(this.element),n=[],i=this.draggablesPayload)s.call(i,a)&&(o=(r=i[a]).content,e=r.htmlclass,(t=$("<span>")).addClass(this.settings.draggable_class).attr("data-label",a).attr("draggable","true").html(o).appendTo(this.draggablesContainer),e?n.push(t.addClass(e)):n.push(void 0));return n}handleDragStart(e,t){var s,a,r;if(e.originalEvent.dataTransfer.effectAllowed="copy",e.originalEvent.dataTransfer.dropEffect="copy",(a=t.find("img")).length){r=a.get(0);try{e.originalEvent.dataTransfer.setDragImage(r,r.width/2,0)}catch(e){e}}t.css("opacity","0.5"),s=t.data("label").toString();try{e.originalEvent.dataTransfer.setData("text/plain",s)}catch(t){t,e.originalEvent.dataTransfer.setData("text",s)}this.dragData=s}handleDragOver(e,t){var s;s=null;try{s=e.originalEvent.dataTransfer.getData("text/plain")}catch(t){t,s=e.originalEvent.dataTransfer.getData("text")}return s||(s=this.dragData),!(s&&this.draggablesPayload[s]&&!t.hasClass("correct"))||(e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="copy",!1)}handleDragEnter(e,t){e.preventDefault(),t.hasClass("correct")||t.addClass("over")}handleDragLeave(e,t){t.removeClass("over")}handleDrop(e,t){var s,a;e.stopPropagation(),e.preventDefault(),s=null;try{s=e.originalEvent.dataTransfer.getData("text/plain")}catch(t){t,s=e.originalEvent.dataTransfer.getData("text")}return s||(s=this.dragData),a=t.data("label").toString(),this.checkAnswer(s,a,t),!1}handleDragEnd(e,t){t.css("opacity",""),this.element.find(this.settings.droppable_selector).removeClass("over"),this.dragData=null,this.completed&&this.detachDragEventHandlers()}handleDroppableClick(e,t){var s,a,r,i,n;return e.stopPropagation(),e.preventDefault(),a=t.data("id"),!(this.questionAnswered[a].length<1&&!this.selectedDrag)&&(r=t.data("label").toString(),this.selectedDrag&&!t.hasClass("correct")?(s=this.selectedDrag.data("label").toString(),this.checkAnswer(s,r,t),this.completed&&this.detachDragEventHandlers()):(s=this.latestAnswers[a],i=this.getFeedback(s,r,a),this.updateFeedback(i,this.isCorrectAnswer(s,r)),this.completed||(n={qid:a,qlabel:r,alabel:s,time:(new Date).toISOString(),click:!0},this.answerLog.push(n))),!1)}handleDraggableClick(e,t){return t.is(this.selectedDrag)?(this.selectedDrag.removeClass("selected"),this.selectedDrag=null):(this.selectedDrag&&this.selectedDrag.removeClass("selected"),this.selectedDrag=t,this.selectedDrag.addClass("selected"))}checkAnswer(e,t,s){var a,r,i,n,o,l;this.completed||s.hasClass("correct")||(r=s.data("id"),this.latestAnswers[r]=e,l=!0,-1===this.questionAnswered[r].indexOf(e)&&(this.questionAnswered[r].push(e),l=!1),a=this.draggablesPayload[e],n=this.isCorrectAnswer(e,t),i=this.getFeedback(e,t,r),this.updateFeedback(i,n),s.removeClass("correct wrong"),n?(s.addClass("correct"),a.htmlclass&&s.addClass(a.htmlclass),l||this.correctAnswers++,!1===a.reuse&&this.disableDraggable(e)):(s.addClass("wrong"),l||this.incorrectAnswers++),this.revealAnswerInDroppable(e,s,n),this.updatePoints(),this.updateCorrectDragsLeftMessage(),o={qid:r,qlabel:t,alabel:e,time:(new Date).toISOString()},l&&(o.rerun=!0),this.answerLog.push(o),this.quitButton.prop("disabled",!1),this.checkCompletion())}checkCompletion(){this.correctAnswers>=this.maxCorrectAnswers&&this.completeExercise(!1)}completeExercise(e=!1){if(!this.completed)return this.completed=!0,this.quitButton.prop("disabled",!0),e||this.dragsLeftMsgDiv.hide(),e&&this.detachDragEventHandlers(),this.completeMsg.text(this.completeDiv.attr(this.settings.complete_msg_attr)),this.completeDiv.removeClass("hide").show(),this.grade(),this.sendLog()}grade(){var e,t,s,a;a=this,"/html/"!==window.location.pathname.substring(0,6)&&this.completeMsg.text(this.completeDiv.attr(this.settings.complete_uploading_msg_attr)),t=3*(this.maxCorrectAnswers-this.correctAnswers),s=Math.round(this.maxCorrectAnswers/(this.correctAnswers+this.incorrectAnswers+t)*100),this.addFinalPointsString(this.pointsDiv,s),this.showFinalComment(s),e=this.buildFinalFeedback(),window.ACOS&&window.ACOS.sendEvent("grade",{max_points:100,points:s,feedback:e},function(e,t){t?a.completeMsg.text(a.completeDiv.attr(a.settings.complete_error_msg_attr)+t.error):"/html/"!==window.location.pathname.substring(0,6)&&a.completeMsg.text(a.completeDiv.attr(a.settings.complete_uploaded_msg_attr))})}sendLog(){window.ACOS&&window.ACOS.sendEvent("log",this.answerLog)}disableDraggable(e){var t;(t=this.draggablesContainer.find(this.settings.draggable_selector+'[data-label="'+e+'"]')).attr("draggable","false").addClass("disabled").removeClass("selected").off("click"),t.is(this.selectedDrag)&&(this.selectedDrag=null),t.find("img, a").attr("draggable","false")}updatePoints(){this.correctPointsElem.text(this.correctAnswers),this.wrongPointsElem.text(this.incorrectAnswers),this.pointsDiv.removeClass("hide").show()}updateCorrectDragsLeftMessage(){var e,t,s;this.correctAnswers>=.5*this.maxCorrectAnswers&&(s=1===(e=this.maxCorrectAnswers-this.correctAnswers)?this.settings.drags_left_singular_msg_attr:this.settings.drags_left_plural_msg_attr,t=(t=this.dragsLeftMsgDiv.attr(s)).replace("{counter}",e.toString()),this.dragsLeftMsgDiv.html(t),this.dragsLeftMsgDiv.removeClass("hide").show())}showFinalComment(e){var t,a,r,i,n,o;if(o=window.draganddrop.finalcomment){for(r in a="",o.common&&(a+=o.common+"<br>"),n=[],o)s.call(o,r)&&(o[r],i=parseInt(r,10),isNaN(i)||n.push([i,r]));n.sort(function(e,t){return e[0]<t[0]?-1:e[0]>t[0]?1:0}),-1!==(t=n.findIndex(function(t){return e<=t[0]}))&&(a+=o[n[t][1]]),this.finalComment.html(a),this.finalComment.removeClass("hide").show()}}detachDragEventHandlers(){this.element.find(this.settings.droppable_selector).off("dragover dragenter dragleave drag"),this.draggablesContainer.find(this.settings.draggable_selector).off("dragstart dragend click").attr("draggable","false").addClass("finished"),this.selectedDrag&&(this.selectedDrag.removeClass("selected"),this.selectedDrag=null)}addFinalPointsString(e,t){var s;s=(s=e.attr(this.settings.final_points_msg_attr)).replace("{score}",t.toString()),e.prepend(s)}setDraggablesPosition(){var e;this.draggablesContainer.hasClass("vertical")||(.8*$(window).height()>this.contentDiv.height()?(this.draggablesContainer.removeClass("fixed"),this.contentDiv.removeClass("fixed-draggables"),this.draggablesContainer.css("maxHeight",.25*$(window).height()),this.contentDiv.css("marginTop","")):(this.draggablesContainer.addClass("fixed"),this.contentDiv.addClass("fixed-draggables"),this.draggablesContainer.css("maxHeight",""),e=Math.min(this.draggablesContainer.height(),.25*$(window).height()),this.draggablesContainer.css("maxHeight",e),this.contentDiv.css("marginTop",e)))}buildFinalFeedback(){return{answers:this.questionAnswered,correctAnswers:this.correctAnswers,incorrectAnswers:this.incorrectAnswers}}}return e.pluginName="acosDragAndDrop",e.defaults=$.extend({},t.defaults,{points_selector:".draganddrop-points",correct_answers_selector:".draganddrop-correct-answers",wrong_answers_selector:".draganddrop-wrong-answers",completed_selector:".draganddrop-complete",draggable_selector:".draggable",draggable_class:"draggable",draggables_selector:".draganddrop-draggables",draggables_container_class:"draganddrop-draggables",complete_msg_attr:"data-msg-complete",complete_uploading_msg_attr:"data-msg-complete-uploading",complete_uploaded_msg_attr:"data-msg-complete-uploaded",complete_error_msg_attr:"data-msg-complete-error",completed_msg_selector:".draganddrop-complete-msg",final_comment_selector:".draganddrop-finalcomment",final_points_msg_attr:"data-msg-final",drags_left_msg_selector:".draganddrop-dragsleftmsg",drags_left_singular_msg_attr:"data-msg-singular",drags_left_plural_msg_attr:"data-msg-plural",quit_button_selector:"[data-quit-button]"}),e}.call(this),$.fn[e.pluginName]=function(t){return this.each(function(){$.data(this,"plugin_"+e.pluginName)||$.data(this,"plugin_"+e.pluginName,new e(this,t))})},$(function(){return $(".draganddrop").acosDragAndDrop()})}).call(this);